---
title: "В поисках понятного алгоритма консенсуса"
summary: "Raft - это алгоритм консенсуса для управления реплицированным логом.
Он дает результат, эквивалентный (мульти) Paxos, и он так же эффективен, но
его структура отличается от Paxos; это делает Raft более понятным, чем Paxos, а
также обеспечивает лучшую основу для построения практических систем. Чтобы
повысить понятность, Raft разделяет ключевые элементы консенсуса, такие как
выбор лидера, репликация журнала и безопасность, и обеспечивает более высокую
степень согласованности для сокращения числа состояний, которые необходимо
учитывать. Результаты пользовательского исследования показывают, что Raft легче
учиться, чем Paxos. Raft также включает в себя новый механизм изменения членства
в кластере, который использует перекрывающееся большинство для обеспечения
безопасности."
date: 2020-05-16T19:22:56+03:00
draft: true
toc: true
categories:
- paxos
- consencus
- raft
- distributed
---

{{< param Summary >}}

Этот технический отчет является расширенной версией [[32]]; дополнительный
материал отмечен серой полосой на полях. Опубликовано 20 мая 2014 г.

## Оригинал {#origin}

Diego Ongaro and John Ousterhout, [In Search of an Understandable Consensus
Algorithm (Extended Version)](https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf)

## Введение {#introduction}

Консенсусные алгоритмы позволяют совокупности машин работать как единая группа,
которая может пережить сбои (падения) некоторых ее членов. Поэтому они играют
ключевую роль в создании надежных крупномасштабных программных систем. Paxos
[[15], [16]] доминировал в обсуждении алгоритмов консенсуса в течение последнего
десятилетия: большинство реализаций консенсуса основаны на Paxos или под его
влиянием, и Paxos стал основным средством, используемым для обучения студентов
консенсусу.

К сожалению, Paxos довольно сложно понять, даже несмотря на многочисленные
попытки сделать его более доступным. Более того, его архитектура требует сложных
изменений для поддержки практических систем. В результате, как разработчики
систем, так и студенты борются с Paxos.

После того, как мы сами боролись с Paxos, мы решили найти новый алгоритм поиска
консенсуса, который мог бы обеспечить лучшую основу для построения систем и
обучения. Наш подход был необычным в том смысле, что нашей главной целью была
понятность: можем ли мы определить алгоритм консенсуса для практических систем
и описать его так, чтобы его было значительно легче изучить, чем Paxos? Более
того, мы хотели, чтобы алгоритм способствовать развитию интуиции, которые
необходимы для разработчиков систем. Важно было не только, чтобы алгоритм
работал, но и чтобы было понятно, почему он работает.

Результатом этой работы является алгоритм поиска согласованного состояния
(консенсуса) под названием Raft. При разработке Raft мы применяли специальные
методы для улучшения понимания, включая декомпозицию (Raft разделяет выбор
лидера, журнал репликации и безопасность) и сокращение пространства состояний
(по сравнению с Paxos, Raft уменьшает степень недетерминированности и то, как
серверы могут быть несовместимы друг с другом). Пользовательское исследование с
43 студентами в двух университетах показывает, что Raft значительно легче
понять, чем Paxos: после изучения обоих алгоритмов 33 из этих студентов смогли
ответить на вопросы о Raft лучше, чем на вопросы о Paxos.

Raft во многом похож на существующие алгоритмы консенсуса (в частности,
Viewstamped Replication Оки и Лискова [[29], [22]]), но у него есть несколько
нововведений:

- *Сильный лидер*: Raft использует более сильную форму лидерства, чем другие
  алгоритмы консенсуса. Например, записи журнала передаются только от лидера
  к другим серверам. Это упрощает управление журналом репликации и
  облегчает понимание Raft.

- *Выбор лидера*: Raft использует случайные таймеры для выбора лидеров. Это
  добавляет лишь небольшое количество работы к сигналам сихнронизации
  (heartbeat), которые и так требуются для любого алгоритма консенсуса. Но при
  этом упрощаются и ускоряеются разрешения конфликтов.

- *Изменения в членстве*: Механизм Raft для изменения набора серверов в кластере
  использует новый совместный консенсусный подход, при котором большинство двух
  разных конфигураций перекрываются во время переходов. Это позволяет кластеру
  нормально работать во время изменений конфигурации.

Мы считаем, что Raft превосходит Paxos и другие алгоритмы консенсуса, как в
образовательных целях, так и в качестве основы для реализации. Он проще и
понятнее, чем другие алгоритмы; он описан достаточно полно, чтобы удовлетворить
потребности практической системы; он имеет несколько реализаций с открытым
исходным кодом и используется несколькими компаниями; его защитные свойства были
официально определены и доказаны; и его эффективность сопоставима с другими
алгоритмами.

Оставшиеся части статьи знакомят с проблемой реплицированных конечных автоматов
(*replicated state machine, RSM*) (раздел 2), обсуждают сильные и слабые стороны
Paxos (раздел 3), описывают наш обобщенный подход к пониманиемости (раздел 4),
представляют алгоритм консенсуса Raft (разделы 5–8), дают оценку Raft (Раздел 9)
и обсуждают связанную с этим работу (Раздел 10).

## Replicated state machines

Алгоритмы консенсуса обычно возникают в контексте реплицированных конечных
автоматов [[37]]. При таком подходе конечные автоматы на нескольких серверах
вычисляют идентичные копии одного и того же состояния и могут продолжать
работать, даже если некоторые из серверов не работают.

Реплицированные конечные автоматы используются для решения различных проблем
отказоустойчивости в распределенных системах. Например, в больших масштабируемых
системах, в которых один лидер в кластере, таких как GFS [[8]], HDFS [[38]] и
RAMCloud [[33]], обычно используется отдельный реплицированный конечный автомат
для управления выбором лидера и хранения информации о конфигурации, которая
должна сохраниться при падении лидера. Примеры реплицированных конечных
автоматов включают Chubby [[2]] и ZooKeeper [[11]].

Реплицированные конечные автоматы обычно реализуются с использованием
журнала репликации, как показано на [рисунке 1]({{< relref "#rsm_arch" >}}). Каждый сервер хранит
журнал, содержащий серию команд, которые его конечный автомат выполняет по
порядку. Каждый журнал содержит одинаковые команды в одинаковом порядке, поэтому
каждый конечный автомат обрабатывает одну и ту же последовательность команд.
Поскольку конечные автоматы являются детерминированными, каждый вычисляет одно и
то же состояние и одну и ту же последовательность выходных данных.

{{< figure_wid id="rsm_arch" src="/img/raft/rsm_arch.png" title="Рисунок 1. Архитектура реплицированного конечного автомата." caption="Алгоритм консенсуса (consensus module) управляет журналом репликации (Log), содержащим команды конечного автомата от клиентов (clients). Конечные автоматы обрабатывают идентичные последовательности команд из журналов, поэтому они выдают одинаковые выходные данные." >}}

Поддержка лога репликации в согласованном состоянии - задача алгоритма
консенсуса. Модуль консенсуса на сервере получает команды от клиентов и
добавляет их в свой журнал. Он общается с модулями консенсуса на других
серверах, чтобы гарантировать, что каждый журнал в конечном итоге содержит
одинаковые запросы в одинаковом порядке, даже если некоторые серверы выходят из
строя. Как только команды отреплицированы, конечный автомат каждого сервера
обрабатывает их в порядке ведения журнала, а выходные данные возвращаются
клиентам. В результате серверы образуют единый высоконадежный конечный автомат.

[2]: ...
[8]: ...
[11]: ...
[15]: ...
[16]: ...
[22]: ...
[29]: ...
[32]: ...
[33]: ...
[37]: ...
[38]: ...
